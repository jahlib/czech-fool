<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>–ß–µ—à—Å–∫–∏–π</title>
    <!-- –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –∏ —É–∫–∞–∂–∏—Ç–µ –≤–∞—à WebSocket –¥–æ–º–µ–Ω –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ reverse proxy -->
    <!-- <meta name="ws-host" content="ws.domain.com"> -->
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
    <link rel="shortcut icon" href="/icon-192.png">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#667eea">
    
    <!-- iOS Icons -->
    <link rel="apple-touch-icon" href="/icon-192.png">
    
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div id="app">
        <!-- –≠–∫—Ä–∞–Ω –ª–æ–±–±–∏ -->
        <div id="lobby-screen" class="screen active">
            <div class="container">
                <h1>üé¥ –ß–µ—à—Å–∫–∏–π</h1>
                
                <div id="create-room-section">
                    <h2>–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</h2>
                    <input type="text" id="nickname-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º" maxlength="20">
                    <button id="create-room-btn" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
                    
                    <div id="bot-game-section">
                        <h3>ü§ñ –ò–≥—Ä–∞—Ç—å —Å –±–æ—Ç–∞–º–∏</h3>
                        <div class="bot-buttons">
                            <button id="play-with-1-bot-btn" class="btn btn-bot">–ò–≥—Ä–∞—Ç—å —Å 1 –±–æ—Ç–æ–º</button>
                            <button id="play-with-2-bots-btn" class="btn btn-bot">–ò–≥—Ä–∞—Ç—å —Å 2 –±–æ—Ç–∞–º–∏</button>
                            <button id="play-with-3-bots-btn" class="btn btn-bot">–ò–≥—Ä–∞—Ç—å —Å 3 –±–æ—Ç–∞–º–∏</button>
                        </div>
                    </div>
                </div>
                
                <div id="rooms-section">
                    <h2>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–Ω–∞—Ç—ã</h2>
                    <div id="rooms-list"></div>
                </div>
                
                <div id="rules-section">
                    <h2>üìñ –ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã</h2>
                    <div id="lobby-rules-content" class="rules-content"></div>
                </div>
            </div>
        </div>
        
        <!-- –≠–∫—Ä–∞–Ω –∫–æ–º–Ω–∞—Ç—ã -->
        <div id="room-screen" class="screen">
            <div class="container">
                <div class="room-header">
                    <h2>–ö–æ–º–Ω–∞—Ç–∞</h2>
                    <button id="leave-room-btn" class="btn btn-secondary">–ü–æ–∫–∏–Ω—É—Ç—å</button>
                </div>
                
                <div id="players-waiting">
                    <h3>–ò–≥—Ä–æ–∫–∏ –≤ –∫–æ–º–Ω–∞—Ç–µ:</h3>
                    <div id="players-list"></div>
                    <div id="countdown-display" style="display: none;">
                        <div class="countdown-timer">
                            <span id="countdown-number">6</span>
                        </div>
                        <p class="countdown-text">–ò–≥—Ä–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è...</p>
                    </div>
                    <button id="ready-toggle-btn" class="btn btn-primary">–ì–æ—Ç–æ–≤</button>
                    <p class="hint">–ò–≥—Ä–∞ –Ω–∞—á–Ω—ë—Ç—Å—è –∫–æ–≥–¥–∞ –≤—Å–µ –∏–≥—Ä–æ–∫–∏ –±—É–¥—É—Ç –≥–æ—Ç–æ–≤—ã (–º–∏–Ω–∏–º—É–º 2 –∏–≥—Ä–æ–∫–∞)</p>
                </div>
            </div>
        </div>
        
        <!-- –≠–∫—Ä–∞–Ω –æ—à–∏–±–∫–∏ -->
        <div id="error-screen" class="screen">
            <div class="error-container">
                <div class="error-content">
                    <h1>üòï</h1>
                    <h2>–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</h2>
                    <p id="error-message">–≠—Ç–∞ –∫–æ–º–Ω–∞—Ç–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞</p>
                    <button id="go-home-btn" class="btn btn-primary">–ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
                </div>
            </div>
        </div>
        
        <!-- –≠–∫—Ä–∞–Ω –∏–≥—Ä—ã -->
        <div id="game-screen" class="screen">
            <div class="game-container">
                <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–Ω–∞—Ç—É -->
                <button id="leave-game-btn" class="leave-game-btn" title="–ü–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–Ω–∞—Ç—É">
                    <span class="leave-icon">üö™</span>
                </button>
                
                <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ -->
                <button id="fullscreen-btn" class="fullscreen-btn" title="–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º">
                    <span class="fullscreen-icon">‚õ∂</span>
                </button>
                
                <!-- –ö–Ω–æ–ø–∫–∞ –ø—Ä–∞–≤–∏–ª -->
                <button id="rules-btn" class="rules-btn" title="–ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã">üìñ</button>
                
                <!-- –ö–Ω–æ–ø–∫–∞ —á–∞—Ç–∞ -->
                <button id="chat-btn" class="chat-btn" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ">üí¨</button>
                
                <!-- –ö–Ω–æ–ø–∫–∞ toggle –ª–æ–≥–æ–≤ (—Ç–æ–ª—å–∫–æ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö) -->
                <button id="toggle-log-btn" class="toggle-log-btn" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ª–æ–≥–∏">
                    <span class="toggle-log-icon">üìã</span>
                </button>
                
                <!-- –ö–Ω–æ–ø–∫–∞ –≤—ã–∫–ª—é—á–µ–Ω–∏—è –∑–≤—É–∫–∞ -->
                <button id="toggle-sound-btn" class="toggle-sound-btn" title="–í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫">
                    <span class="sound-icon">üîä</span>
                </button>
                
                <!-- –ö—Ä—É–≥–æ–≤–æ–µ –∏–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ -->
                <div class="game-table">
                    <!-- –ò–≥—Ä–æ–≤–æ–π –ª–æ–≥ -->
                    <div id="game-log" class="game-log"></div>
                    
                    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–æ–≤ -->
                    <div id="opponents-container">
                        <!-- –ò–≥—Ä–æ–∫ —Å–ª–µ–≤–∞ -->
                        <div class="opponent-area opponent-left" id="opponent-left">
                            <div class="opponent-info">
                                <span class="opponent-name"></span>
                                <span class="opponent-score"></span>
                            </div>
                            <div class="opponent-cards"></div>
                        </div>
                        
                        <!-- –ò–≥—Ä–æ–∫ –ø–æ —Ü–µ–Ω—Ç—Ä—É -->
                        <div class="opponent-area opponent-top" id="opponent-top">
                            <div class="opponent-info">
                                <span class="opponent-name"></span>
                                <span class="opponent-score"></span>
                            </div>
                            <div class="opponent-cards"></div>
                        </div>
                        
                        <!-- –ò–≥—Ä–æ–∫ —Å–ø—Ä–∞–≤–∞ -->
                        <div class="opponent-area opponent-right" id="opponent-right">
                            <div class="opponent-info">
                                <span class="opponent-name"></span>
                                <span class="opponent-score"></span>
                            </div>
                            <div class="opponent-cards"></div>
                        </div>
                    </div>
                    
                    <!-- –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –∫—Ä—É–≥ —Å –∫–∞—Ä—Ç–æ–π –∏ –∫–æ–ª–æ–¥–æ–π -->
                    <div class="game-circle">
                        <div class="center-area">
                            <div class="center-card-wrapper">
                                <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–∞—Å—Ç–∏ -->
                                <div id="chosen-suit-indicator" style="display: none;"></div>
                                <div id="discard-pile" class="center-card"></div>
                            </div>
                            <div class="deck-area">
                                <div class="deck-count-badge" id="deck-count">0</div>
                                <div id="deck" class="card-pile">
                                    <div class="card card-back">üé¥</div>
                                </div>
                                <div class="deck-buttons">
                                    <button id="draw-card-btn" class="btn btn-primary btn-sm">–í–∑—è—Ç—å</button>
                                    <button id="skip-turn-btn" class="btn btn-secondary btn-sm" style="display: none;">–ù–µ—Ç—É</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–≥—Ä–æ–∫–∞ -->
                    <div class="player-container">
                        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏–≥—Ä–æ–∫–µ -->
                        <div class="player-info">
                            <span class="player-name" id="player-name"></span>
                            <span class="player-score" id="player-score"></span>
                        </div>
                        
                        <!-- –ö–∞—Ä—Ç—ã –∏–≥—Ä–æ–∫–∞ –≤–Ω–∏–∑—É -->
                        <div class="player-hand">
                            <div id="hand-cards"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–∞—Ç–∞ -->
        <div id="chat-modal" class="modal">
            <div class="modal-content chat-modal-content">
                <h3>–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</h3>
                <textarea id="chat-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." maxlength="200"></textarea>
                <div class="chat-modal-buttons">
                    <button id="send-chat-btn" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    <button id="close-chat-btn" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>
        
        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –º–∞—Å—Ç–∏ -->
        <div id="suit-modal" class="modal">
            <div class="modal-content">
                <h3>–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Å—Ç—å</h3>
                <div class="suit-selector">
                    <button class="suit-btn" data-suit="hearts">‚ô•Ô∏è –ß–µ—Ä–≤–∏</button>
                    <button class="suit-btn" data-suit="diamonds">‚ô¶Ô∏è –ë—É–±–Ω—ã</button>
                    <button class="suit-btn" data-suit="clubs">‚ô£Ô∏è –¢—Ä–µ—Ñ—ã</button>
                    <button class="suit-btn" data-suit="spades">‚ô†Ô∏è –ü–∏–∫–∏</button>
                </div>
                <div class="modal-buttons" style="margin-top: 15px;">
                    <button id="cancel-suit-btn" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>
        
        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
        <div id="results-modal" class="modal">
            <div class="modal-content">
                <h2>–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!</h2>
                <div id="results-content"></div>
                <button id="close-results-btn" class="btn btn-primary">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
            </div>
        </div>
        
        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –∫–æ–º–Ω–∞—Ç–µ -->
        <div id="join-modal" class="modal">
            <div class="modal-content">
                <h3>–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ</h3>
                <input type="text" id="join-nickname-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º" maxlength="20">
                <div class="modal-buttons">
                    <button id="join-confirm-btn" class="btn btn-primary">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
                    <button id="join-cancel-btn" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ–ø–æ–≤–µ—â–µ–Ω–∏—è -->
        <div id="alert-modal" class="modal">
            <div class="modal-content">
                <h3>–°–æ–æ–±—â–µ–Ω–∏–µ</h3>
                <p id="alert-text" style="margin: 10px 0 20px 0;"></p>
                <div class="modal-buttons">
                    <button id="alert-ok-btn" class="btn btn-primary">–û–ö</button>
                </div>
            </div>
        </div>
        
        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤—ã—Ö–æ–¥–∞ -->
        <div id="leave-confirm-modal" class="modal">
            <div class="modal-content">
                <h3>–ü–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–Ω–∞—Ç—É?</h3>
                <p style="margin: 10px 0 20px 0;">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å –∏–≥—Ä—É?</p>
                <div class="modal-buttons">
                    <button id="leave-confirm-btn" class="btn btn-primary">–î–∞, –≤—ã–π—Ç–∏</button>
                    <button id="leave-cancel-btn" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>
        
        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∞–≤–∏–ª -->
        <div id="rules-modal" class="modal">
            <div class="modal-content rules-modal-content">
                <button id="close-rules-btn" class="close-modal-btn">‚úï</button>
                <h2>üìñ –ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã</h2>
                <div id="rules-content" class="rules-content"></div>
            </div>
        </div>
    </div>
    
    <script src="/marked.min.js"></script>
    <script src="/game.js"></script>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registered:', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed:', err);
                    });
            });
        }
        
        // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ - –Ω–∞—Ö–æ–¥–∏–º—Å—è –ª–∏ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ (–ª–æ–±–±–∏)
        function isOnLobbyScreen() {
            const lobbyScreen = document.getElementById('lobby-screen');
            return lobbyScreen && lobbyScreen.classList.contains('active');
        }
        
        // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ - –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ —ç–ª–µ–º–µ–Ω—Ç –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞ —Ä—É–∫–∏
        function isInsidePlayerHand(element) {
            while (element) {
                if (element.classList && element.classList.contains('player-hand')) {
                    return true;
                }
                element = element.parentElement;
            }
            return false;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ - –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ —ç–ª–µ–º–µ–Ω—Ç –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª–∫–∏ —Å –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π
        function isInsideScrollableModal(element) {
            while (element) {
                if (element.classList && (
                    element.classList.contains('rules-modal-content') ||
                    element.classList.contains('modal-content')
                )) {
                    return true;
                }
                element = element.parentElement;
            }
            return false;
        }
        
        // –û—Ç–∫–ª—é—á–∞–µ–º pull-to-refresh —Ç–æ–ª—å–∫–æ –ù–ï –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        let touchStartY = 0;
        document.addEventListener('touchstart', function(e) {
            touchStartY = e.touches[0].clientY;
        }, { passive: false });
        
        document.addEventListener('touchmove', function(e) {
            // –†–∞–∑—Ä–µ—à–∞–µ–º –≤—Å–µ –∂–µ—Å—Ç—ã –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            if (isOnLobbyScreen()) {
                return;
            }
            
            // –†–∞–∑—Ä–µ—à–∞–µ–º —Å–∫—Ä–æ–ª–ª –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞ —Ä—É–∫–∏ –∏–≥—Ä–æ–∫–∞
            if (isInsidePlayerHand(e.target)) {
                return;
            }
            
            // –†–∞–∑—Ä–µ—à–∞–µ–º —Å–∫—Ä–æ–ª–ª –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª–æ–∫
            if (isInsideScrollableModal(e.target)) {
                return;
            }
            
            const touchY = e.touches[0].clientY;
            const touchDiff = touchY - touchStartY;
            
            // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç—è–Ω–µ—Ç –≤–Ω–∏–∑ –Ω–∞ –≤–µ—Ä—Ö—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã - –±–ª–æ–∫–∏—Ä—É–µ–º
            if (touchDiff > 0 && window.scrollY === 0) {
                e.preventDefault();
            }
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –º—É–ª—å—Ç–∏—Ç–∞—á
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        }, { passive: false });
        
        // –û—Ç–∫–ª—é—á–∞–µ–º –¥–≤–æ–π–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ –¥–ª—è –∑—É–º–∞ —Ç–æ–ª—å–∫–æ –ù–ï –Ω–∞ –≥–ª–∞–≤–Ω–æ–π
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(e) {
            // –†–∞–∑—Ä–µ—à–∞–µ–º –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            if (isOnLobbyScreen()) {
                return;
            }
            
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
        
        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —á–µ—Ä–µ–∑ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Ç–æ–ª—å–∫–æ –ù–ï –Ω–∞ –≥–ª–∞–≤–Ω–æ–π
        document.addEventListener('keydown', function(e) {
            // –†–∞–∑—Ä–µ—à–∞–µ–º –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            if (isOnLobbyScreen()) {
                return;
            }
            
            if ((e.key === 'F5') || 
                (e.ctrlKey && e.key === 'r') || 
                (e.metaKey && e.key === 'r')) {
                e.preventDefault();
                return false;
            }
        });
    </script>
</body>
</html>
